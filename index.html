<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>Budget Command Center</title>

  <style>
    body { margin:0; font-family:-apple-system,BlinkMacSystemFont,system-ui,sans-serif; background:#0b1220; color:#e8eefc; padding:16px; }
    h1 { font-size:18px; margin:0 0 12px; }
    .card { background:#121a2b; padding:16px; border-radius:12px; margin-bottom:16px; border:1px solid #24314f; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:flex-start; justify-content:space-between; }
    .btnRow { display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-start; }
    button { padding:10px 14px; border-radius:10px; border:none; font-weight:900; cursor:pointer; }
    .primary { background:#64d2ff; color:#0b1220; }
    .danger { background:#ff6b6b; color:#fff; }
    .ghost { background:#0f1726; color:#e8eefc; border:1px solid #24314f; }
    input, select { padding:10px; border-radius:10px; border:1px solid #24314f; background:#0f1726; color:#e8eefc; width:100%; }
    label { font-size:12px; color:#9fb0d0; display:block; margin-bottom:6px; }
    table { width:100%; font-size:12px; border-collapse:collapse; }
    th, td { padding:8px 6px; border-bottom:1px solid #24314f; vertical-align:top; }
    th { color:#9fb0d0; text-align:left; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #24314f; border-radius:999px; color:#9fb0d0; font-size:11px; }
    .pos { color:#6bff95; }
    .neg { color:#ff6b6b; }
    .small { font-size:12px; color:#9fb0d0; line-height:1.4; margin:8px 0 0; }
    .kpi { font-size:34px; font-weight:950; margin:6px 0 0; letter-spacing:-.5px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .grid3 { display:grid; grid-template-columns: 1fr; gap:10px; }
    @media(min-width:820px){ .grid3 { grid-template-columns: 1fr 1fr 1fr; } }
    .kpiBox { background:#0f1726; border:1px solid #24314f; border-radius:12px; padding:12px; }
    .kpiBox .t { color:#9fb0d0; font-size:12px; }
    .kpiBox .v { font-size:20px; font-weight:900; margin-top:6px; }
    .hint { color:#9fb0d0; font-size:12px; }
    .warn { color:#ffd36b; }
    canvas { max-width:100%; background:#0f1726; border:1px solid #24314f; border-radius:12px; }
    .right { text-align:right; }
  </style>
</head>

<body>
  <h1>Budget Command Center</h1>

  <div class="card">
    <div class="row">
      <div style="min-width:340px;">
        <div class="pill" id="scopePill">Scope</div>
        <div id="topLine" class="kpi">$0.00</div>
        <div id="topSub" class="small"></div>
        <div id="balanceSub" class="small"></div>
      </div>

      <div style="min-width:340px;">
        <label for="viewMode">View mode</label>
        <select id="viewMode">
          <option value="range" selected>Date range (recommended)</option>
          <option value="month">Month</option>
          <option value="all">All time</option>
        </select>

        <div id="rangeWrap" style="margin-top:10px;">
          <div class="row">
            <div style="min-width:150px; flex:1;">
              <label for="rangeStart">Start</label>
              <input id="rangeStart" type="date" />
            </div>
            <div style="min-width:150px; flex:1;">
              <label for="rangeEnd">End</label>
              <input id="rangeEnd" type="date" />
            </div>
          </div>
          <div class="btnRow" style="margin-top:8px;">
            <button class="ghost" id="rangeToDataBtn">Use full imported data range</button>
            <button class="ghost" id="rangeLast90Btn">Last 90 days</button>
          </div>
        </div>

        <div id="monthWrap" style="margin-top:10px; display:none;">
          <label for="monthSelect">Month</label>
          <input id="monthSelect" type="month" />
        </div>

        <div style="margin-top:10px;">
          <label for="chartMode">Pie chart</label>
          <select id="chartMode">
            <option value="spending" selected>Spending by Category</option>
            <option value="cashflow">Cashflow: Inflows vs Outflows</option>
          </select>
        </div>
      </div>
    </div>

    <div style="margin-top:12px;">
      <canvas id="pieCanvas" width="900" height="360"></canvas>
      <div id="pieLegend" class="small"></div>
    </div>

    <p class="small">
      <b>Running balance:</b> Uses the most recent marker row (Transaction=Balance OR Name/Memo contains “starting balance”)
      on/before the scope end date, then sums transactions forward to the end date.
    </p>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px;">Totals (Current Scope)</h3>
    <div class="grid3">
      <div class="kpiBox"><div class="t">Income</div><div id="income" class="v pos">$0.00</div></div>
      <div class="kpiBox"><div class="t">Outflows</div><div id="outflows" class="v neg">$0.00</div></div>
      <div class="kpiBox"><div class="t">Spending (Transfers Excluded)</div><div id="spending" class="v neg">$0.00</div></div>
      <div class="kpiBox"><div class="t">Transfers (Net)</div><div id="transfers" class="v">$0.00</div></div>
      <div class="kpiBox"><div class="t">Net Change (All Tx)</div><div id="netChange" class="v">$0.00</div></div>
      <div class="kpiBox"><div class="t">Running Balance (Computed)</div><div id="balanceBox" class="v">$0.00</div><div id="balanceHint" class="hint"></div></div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px;">Import CSV</h3>
    <input type="file" id="fileInput" accept=".csv,text/csv" />
    <div class="btnRow" style="margin-top:10px;">
      <button class="primary" id="importBtn">Import (Add to History)</button>
      <button class="ghost" id="removeMarkersBtn">Remove ALL Starting Balance Rows</button>
      <button class="danger" id="clearBtn">Start Fresh (Delete Everything)</button>
    </div>
    <p id="status" class="small"></p>
    <div id="debug" class="small mono"></div>
  </div>

  <div class="card">
    <div class="row">
      <h3 style="margin:0;">Transactions (Current Scope)</h3>
      <span id="countPill" class="pill">0 rows</span>
    </div>
    <div style="overflow:auto; margin-top:10px;">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Transaction</th>
            <th>Name</th>
            <th>Memo</th>
            <th>Category</th>
            <th class="mono right">Amount</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

<script>
/* =========================
   Storage
========================= */
let allTransactions = JSON.parse(localStorage.getItem("transactions") || "[]");
let importMeta = JSON.parse(localStorage.getItem("importMeta") || "[]");
function saveAll() {
  localStorage.setItem("transactions", JSON.stringify(allTransactions));
  localStorage.setItem("importMeta", JSON.stringify(importMeta));
}

/* =========================
   CSV parser
========================= */
function parseCSV(text) {
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    const next = text[i + 1];

    if (c === '"') {
      if (inQuotes && next === '"') { cur += '"'; i++; }
      else { inQuotes = !inQuotes; }
    } else if (c === ',' && !inQuotes) {
      row.push(cur); cur = "";
    } else if ((c === '\n' || c === '\r') && !inQuotes) {
      if (c === '\r' && next === '\n') i++;
      row.push(cur); cur = "";
      if (row.some(cell => cell.trim() !== "")) rows.push(row);
      row = [];
    } else {
      cur += c;
    }
  }
  if (cur.length || row.length) { row.push(cur); rows.push(row); }
  return rows;
}

/* =========================
   Money + Dates
========================= */
function parseMoney(value) {
  if (value === null || value === undefined) return null;
  let s = String(value).trim();
  if (!s) return null;

  const isParenNeg = s.startsWith("(") && s.endsWith(")");
  if (isParenNeg) s = s.slice(1, -1);

  s = s.replace(/\$/g, "").replace(/,/g, "").trim();
  const n = Number(s);
  if (Number.isNaN(n)) return null;
  return isParenNeg ? -n : n;
}
function money(n) {
  return Number(n || 0).toLocaleString("en-US", { style: "currency", currency: "USD" });
}
function parseUSDate(mmddyyyy) {
  const s = (mmddyyyy || "").trim();
  const parts = s.split("/");
  if (parts.length !== 3) return null;
  const mm = parseInt(parts[0], 10);
  const dd = parseInt(parts[1], 10);
  const yyyy = parseInt(parts[2], 10);
  if (!mm || !dd || !yyyy) return null;
  const d = new Date(yyyy, mm - 1, dd);
  if (Number.isNaN(d.getTime())) return null;
  return d;
}
function yyyymmFromDate(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  return `${y}-${m}`;
}
function indexOfAny(headers, candidates) {
  const upper = headers.map(h => (h || "").trim().toUpperCase());
  for (const c of candidates) {
    const idx = upper.indexOf(c.toUpperCase());
    if (idx >= 0) return idx;
  }
  return -1;
}
function maxDateISO(records) {
  if (!records.length) return null;
  return records.reduce((max, r) => (r.dateISO > max ? r.dateISO : max), records[0].dateISO);
}
function minDateISO(records) {
  if (!records.length) return null;
  return records.reduce((min, r) => (r.dateISO < min ? r.dateISO : min), records[0].dateISO);
}
function isoAddDays(dateISO, n) {
  const d = new Date(dateISO + "T00:00:00");
  d.setDate(d.getDate() + n);
  return d.toISOString().slice(0, 10);
}
function daysBetweenISO(aISO, bISO) {
  const a = new Date(aISO + "T00:00:00");
  const b = new Date(bISO + "T00:00:00");
  return Math.round((b - a) / (1000*60*60*24));
}

/* =========================
   Marker + categorization
========================= */
function isMarkerRow(txType, name, memo) {
  const t = (txType || "").toLowerCase().trim();
  const n = (name || "").toLowerCase();
  const m = (memo || "").toLowerCase();
  return (t === "balance") || n.includes("starting balance") || m.includes("starting balance");
}
function categorize(txType, name, memo, amount) {
  if (isMarkerRow(txType, name, memo)) return "Starting Balance";

  const N = (name || "").toUpperCase();
  const M = (memo || "").toUpperCase();
  const T = (txType || "").toUpperCase();

  if (N.includes("PAYMENT TO CREDIT CARD") || M.includes("PAYMENT TO CREDIT CARD") || N.includes("CREDIT CARD PAYMENT") || M.includes("CREDIT CARD PAYMENT"))
    return "Transfer";

  if (N.includes("FIDELITY") || M.includes("FIDELITY") || N.includes("FID BKG") || M.includes("FID BKG")) return "Investing";
  if (N.includes("SPECTRUM") || M.includes("SPECTRUM") || N.includes("WE ENERGIES") || M.includes("WE ENERGIES")) return "Utilities";
  if (N.includes("US CELL") || M.includes("USCELL") || N.includes("VERIZON") || M.includes("VERIZON")) return "Phone";
  if (N.includes("KWIK TRIP") || M.includes("KWIK TRIP") || N.includes("EXXON") || M.includes("EXXON") || N.includes("SHELL") || M.includes("SHELL")) return "Gas";
  if (N.includes("PICK N SAVE") || M.includes("PICK N SAVE") || N.includes("KROGER") || M.includes("KROGER") || N.includes("COSTCO") || M.includes("COSTCO")) return "Groceries";
  if (N.includes("AMAZON") || M.includes("AMAZON") || N.includes("TARGET") || M.includes("TARGET") || N.includes("WALMART") || M.includes("WALMART")) return "Shopping";
  if (N.includes("DISNEY") || M.includes("DISNEY") || N.includes("APPLE") || M.includes("APPLE") || N.includes("NETFLIX") || M.includes("NETFLIX") || N.includes("CHATGPT") || M.includes("CHATGPT")) return "Subscriptions";
  if (T === "CREDIT" && (N.includes("PAYROLL") || M.includes("PAYROLL") || N.includes("DIRECT DEP") || M.includes("DIRECT DEP") || N.includes("DEPOSIT") || M.includes("DEPOSIT"))) return "Income";

  return "Other";
}

/* =========================
   Import
========================= */
async function importCSVFile(file) {
  const text = await file.text();
  const rows = parseCSV(text);
  if (rows.length < 2) throw new Error("CSV looks empty.");

  const header = rows[0].map(h => (h || "").trim());
  const iDate = indexOfAny(header, ["Date", "Posting Date", "Transaction Date"]);
  const iTx   = indexOfAny(header, ["Transaction", "Type"]);
  const iName = indexOfAny(header, ["Name", "Merchant", "Description"]);
  const iMemo = indexOfAny(header, ["Memo", "Details", "Note"]);
  const iAmt  = indexOfAny(header, ["Amount", "Transaction Amount"]);

  if (iDate < 0 || iName < 0 || iAmt < 0) throw new Error("Missing required columns. Need Date + Name + Amount.");

  let added = 0, skipped = 0, failed = 0;
  const debugRows = [];
  let minISO = null, maxISO = null;

  for (const r of rows.slice(1)) {
    try {
      const dateStr = (r[iDate] ?? "").trim();
      const txType  = (iTx >= 0 ? (r[iTx] ?? "").trim() : "");
      const name    = (r[iName] ?? "").trim();
      const memo    = (iMemo >= 0 ? (r[iMemo] ?? "").trim() : "");
      const amount  = parseMoney(r[iAmt]);

      const d = parseUSDate(dateStr);
      if (!d || amount === null) { failed++; continue; }

      const dateISO = d.toISOString().slice(0,10);
      const month = yyyymmFromDate(d);

      minISO = (!minISO || dateISO < minISO) ? dateISO : minISO;
      maxISO = (!maxISO || dateISO > maxISO) ? dateISO : maxISO;

      const category = categorize(txType, name, memo, amount);

      const key = `${dateISO}|${(txType||"").toUpperCase()}|${name}|${memo}|${amount.toFixed(2)}`;
      if (allTransactions.some(t => t.key === key)) { skipped++; continue; }

      allTransactions.push({ key, dateISO, month, txType, name, memo, amount, category });
      added++;
      if (debugRows.length < 6) debugRows.push(allTransactions[allTransactions.length-1]);
    } catch {
      failed++;
    }
  }

  importMeta.push({ fileName:file.name, importedAtISO:new Date().toISOString(), added, skipped, failed, range:{minISO,maxISO} });
  saveAll();
  return { added, skipped, failed, debugRows, range:{minISO,maxISO} };
}

/* =========================
   Scope filtering
========================= */
function getDataRange() {
  return { minISO: minDateISO(allTransactions) || "", maxISO: maxDateISO(allTransactions) || "" };
}

function getScope() {
  const mode = els.viewMode.value;

  if (mode === "all") {
    const { minISO, maxISO } = getDataRange();
    return { mode, startISO: minISO, endISO: maxISO, label: `All time (${minISO} → ${maxISO})` };
  }

  if (mode === "month") {
    const month = els.monthSelect.value || yyyymmFromDate(new Date());
    const startISO = `${month}-01`;
    const [y,m] = month.split("-").map(n=>parseInt(n,10));
    const last = new Date(y, m, 0).toISOString().slice(0,10);
    return { mode, startISO, endISO:last, label: `Month ${month}` };
  }

  // range
  const { minISO, maxISO } = getDataRange();
  const startISO = els.rangeStart.value || minISO;
  const endISO = els.rangeEnd.value || maxISO;
  return { mode:"range", startISO, endISO, label: `Range ${startISO} → ${endISO}` };
}

function filterToScope(tx, scope) {
  const s = scope.startISO || "0000-01-01";
  const e = scope.endISO || "9999-12-31";
  return tx.filter(t => t.dateISO >= s && t.dateISO <= e);
}

/* =========================
   Totals + balance
========================= */
function scopeTotals(scopeTxAll) {
  const scopeTx = scopeTxAll.filter(t => t.category !== "Starting Balance");
  const income = scopeTx.filter(t => t.amount > 0).reduce((s,t)=>s+t.amount,0);
  const outflows = scopeTx.filter(t => t.amount < 0).reduce((s,t)=>s+Math.abs(t.amount),0);

  const transferOut = scopeTx.filter(t => t.category==="Transfer" && t.amount<0).reduce((s,t)=>s+Math.abs(t.amount),0);
  const transferIn  = scopeTx.filter(t => t.category==="Transfer" && t.amount>0).reduce((s,t)=>s+t.amount,0);
  const transfers = transferIn - transferOut;

  const spending = scopeTx.filter(t=>t.amount<0).filter(t=>t.category!=="Transfer").reduce((s,t)=>s+Math.abs(t.amount),0);
  const netChange = scopeTx.reduce((s,t)=>s + Number(t.amount||0), 0);

  return { income, outflows, transfers, spending, netChange, scopeTxAll, scopeTx };
}

function computeRunningBalanceAt(endISO) {
  if (!endISO) return { runningBal:null, explain:"No end date." };

  const markers = allTransactions
    .filter(t => t.category === "Starting Balance")
    .slice()
    .sort((a,b)=>a.dateISO>b.dateISO?1:-1);

  const candidates = markers.filter(m => m.dateISO <= endISO);
  const anchor = candidates.length ? candidates[candidates.length-1] : null;

  if (!anchor) return { runningBal:null, explain:`No starting balance marker found on/before ${endISO}.` };

  const scope = allTransactions
    .filter(t => t.category !== "Starting Balance")
    .filter(t => t.dateISO >= anchor.dateISO && t.dateISO <= endISO);

  const netSince = scope.reduce((s,t)=>s + Number(t.amount||0), 0);
  return { runningBal: anchor.amount + netSince, explain:`Anchor ${money(anchor.amount)} on ${anchor.dateISO} → as of ${endISO}` };
}

/* =========================
   Pie chart (no libs)
========================= */
function hashToHue(str) { let h=0; for (let i=0;i<str.length;i++) h=(h*31+str.charCodeAt(i))>>>0; return h%360; }
function drawPie(canvas, data, title) {
  const ctx = canvas.getContext("2d");
  const W=canvas.width, H=canvas.height;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle="#0f1726"; ctx.fillRect(0,0,W,H);
  ctx.fillStyle="#e8eefc"; ctx.font="900 18px -apple-system,BlinkMacSystemFont,system-ui,sans-serif";
  ctx.fillText(title, 18, 28);

  const total = data.reduce((s,d)=>s+d.value,0);
  if (!total) {
    ctx.fillStyle="#9fb0d0"; ctx.font="600 14px -apple-system,BlinkMacSystemFont,system-ui,sans-serif";
    ctx.fillText("No data in this scope.", 18, 60);
    return;
  }

  const cx=Math.round(W*0.30), cy=Math.round(H*0.55), r=Math.round(Math.min(W,H)*0.30);
  let start=-Math.PI/2;

  for (const d of data) {
    const frac=d.value/total;
    const end=start+frac*Math.PI*2;
    const hue=hashToHue(d.label);
    ctx.fillStyle=`hsl(${hue} 70% 55%)`;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,end); ctx.closePath(); ctx.fill();
    start=end;
  }

  ctx.fillStyle="#0f1726";
  ctx.beginPath(); ctx.arc(cx,cy,Math.round(r*0.55),0,Math.PI*2); ctx.fill();
  ctx.fillStyle="#e8eefc"; ctx.font="900 16px -apple-system,BlinkMacSystemFont,system-ui,sans-serif";
  ctx.fillText(money(total), cx-55, cy+6);
}

/* =========================
   UI + Dashboard
========================= */
const els = {
  scopePill: document.getElementById("scopePill"),
  topLine: document.getElementById("topLine"),
  topSub: document.getElementById("topSub"),
  balanceSub: document.getElementById("balanceSub"),

  viewMode: document.getElementById("viewMode"),
  rangeWrap: document.getElementById("rangeWrap"),
  rangeStart: document.getElementById("rangeStart"),
  rangeEnd: document.getElementById("rangeEnd"),
  rangeToDataBtn: document.getElementById("rangeToDataBtn"),
  rangeLast90Btn: document.getElementById("rangeLast90Btn"),

  monthWrap: document.getElementById("monthWrap"),
  monthSelect: document.getElementById("monthSelect"),

  chartMode: document.getElementById("chartMode"),
  pieCanvas: document.getElementById("pieCanvas"),
  pieLegend: document.getElementById("pieLegend"),

  income: document.getElementById("income"),
  outflows: document.getElementById("outflows"),
  spending: document.getElementById("spending"),
  transfers: document.getElementById("transfers"),
  netChange: document.getElementById("netChange"),
  balanceBox: document.getElementById("balanceBox"),
  balanceHint: document.getElementById("balanceHint"),

  fileInput: document.getElementById("fileInput"),
  importBtn: document.getElementById("importBtn"),
  removeMarkersBtn: document.getElementById("removeMarkersBtn"),
  clearBtn: document.getElementById("clearBtn"),
  status: document.getElementById("status"),
  debug: document.getElementById("debug"),

  countPill: document.getElementById("countPill"),
  tableBody: document.getElementById("tableBody"),
};

function updateViewModeUI() {
  const mode = els.viewMode.value;
  els.rangeWrap.style.display = (mode === "range") ? "" : "none";
  els.monthWrap.style.display = (mode === "month") ? "" : "none";
}

function updateDashboard() {
  updateViewModeUI();

  const scope = getScope();
  const scopeTxAll = filterToScope(allTransactions, scope);
  const totals = scopeTotals(scopeTxAll);

  els.scopePill.textContent = scope.label;
  els.topLine.textContent = money(totals.spending);
  els.topSub.textContent = `Spending (transfers excluded)`;
  els.income.textContent = money(totals.income);
  els.outflows.textContent = money(totals.outflows);
  els.spending.textContent = money(totals.spending);
  els.transfers.textContent = money(totals.transfers);
  els.netChange.textContent = money(totals.netChange);

  const bal = computeRunningBalanceAt(scope.endISO);
  if (bal.runningBal === null) {
    els.balanceSub.innerHTML = `<span class="warn">Running balance unavailable</span> • ${bal.explain}`;
    els.balanceBox.textContent = "(missing)";
    els.balanceHint.textContent = bal.explain;
  } else {
    els.balanceSub.textContent = `Running balance: ${money(bal.runningBal)} • ${bal.explain}`;
    els.balanceBox.textContent = money(bal.runningBal);
    els.balanceHint.textContent = bal.explain;
  }

  // Pie data
  if (els.chartMode.value === "cashflow") {
    drawPie(els.pieCanvas, [
      { label:"Income", value: totals.income },
      { label:"Outflows", value: totals.outflows },
    ], `Cashflow • ${scope.startISO} → ${scope.endISO}`);
    els.pieLegend.textContent = `Income ${money(totals.income)} • Outflows ${money(totals.outflows)}`;
  } else {
    const spend = totals.scopeTx.filter(t => t.amount < 0).filter(t => t.category !== "Transfer");
    const byCat = new Map();
    for (const t of spend) {
      const c = t.category || "Other";
      byCat.set(c, (byCat.get(c) || 0) + Math.abs(t.amount));
    }
    const data = Array.from(byCat.entries()).map(([label,value])=>({label,value})).sort((a,b)=>b.value-a.value);
    drawPie(els.pieCanvas, data, `Spending by Category • ${scope.startISO} → ${scope.endISO}`);
    els.pieLegend.textContent = data.slice(0,6).map(d => `${d.label}: ${money(d.value)}`).join(" • ") || "No spending data.";
  }

  // Table
  els.countPill.textContent = `${totals.scopeTxAll.length} rows`;
  els.tableBody.innerHTML = "";
  totals.scopeTxAll
    .slice()
    .sort((a,b)=>a.dateISO<b.dateISO?1:-1)
    .slice(0, 900)
    .forEach(t => {
      const amtClass = t.amount >= 0 ? "pos" : "neg";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${t.dateISO}</td>
        <td class="mono">${t.txType || ""}</td>
        <td>${t.name}</td>
        <td>${t.memo || ""}</td>
        <td><span class="pill">${t.category || "Other"}</span></td>
        <td class="mono right ${amtClass}">${money(t.amount)}</td>
      `;
      els.tableBody.appendChild(tr);
    });
}

/* =========================
   Buttons / Events
========================= */
els.viewMode.addEventListener("change", updateDashboard);
els.rangeStart.addEventListener("change", updateDashboard);
els.rangeEnd.addEventListener("change", updateDashboard);
els.monthSelect.addEventListener("change", updateDashboard);
els.chartMode.addEventListener("change", updateDashboard);

els.rangeToDataBtn.addEventListener("click", () => {
  const { minISO, maxISO } = getDataRange();
  els.rangeStart.value = minISO || "";
  els.rangeEnd.value = maxISO || "";
  els.viewMode.value = "range";
  updateDashboard();
});

els.rangeLast90Btn.addEventListener("click", () => {
  const { maxISO } = getDataRange();
  const end = maxISO || new Date().toISOString().slice(0,10);
  const endDate = new Date(end + "T00:00:00");
  const startDate = new Date(endDate);
  startDate.setDate(startDate.getDate() - 90);
  els.rangeStart.value = startDate.toISOString().slice(0,10);
  els.rangeEnd.value = end;
  els.viewMode.value = "range";
  updateDashboard();
});

els.importBtn.addEventListener("click", async () => {
  const f = els.fileInput.files && els.fileInput.files[0];
  if (!f) { els.status.textContent = "Pick a CSV first."; return; }

  els.status.textContent = "Importing…";
  els.debug.textContent = "";

  try {
    const res = await importCSVFile(f);
    els.status.textContent = `Imported. Added ${res.added}, skipped ${res.skipped}, failed ${res.failed}. Range ${res.range.minISO||"?"}→${res.range.maxISO||"?"}`;

    // ✅ THIS IS THE INTUITIVE PART:
    // After import, automatically switch to Range mode covering the imported CSV
    if (res.range.minISO && res.range.maxISO) {
      els.viewMode.value = "range";
      els.rangeStart.value = res.range.minISO;
      els.rangeEnd.value = res.range.maxISO;
    } else {
      // fallback to full data range
      const { minISO, maxISO } = getDataRange();
      els.viewMode.value = "range";
      els.rangeStart.value = minISO || "";
      els.rangeEnd.value = maxISO || "";
    }

    els.debug.textContent = res.debugRows.length
      ? "Sample:\n" + res.debugRows.map(r => `${r.dateISO} | ${r.txType||""} | ${r.name} | ${money(r.amount)} | ${r.category}`).join("\n")
      : "No rows parsed.";

    updateDashboard();
  } catch(e) {
    els.status.textContent = `Import failed: ${e.message || e}`;
  } finally {
    els.fileInput.value = "";
  }
});

els.removeMarkersBtn.addEventListener("click", () => {
  if (!confirm("Remove ALL Starting Balance marker rows?")) return;
  const before = allTransactions.length;
  allTransactions = allTransactions.filter(t => t.category !== "Starting Balance");
  saveAll();
  els.status.textContent = `Removed ${before - allTransactions.length} marker rows.`;
  updateDashboard();
});

els.clearBtn.addEventListener("click", () => {
  if (!confirm("Start fresh? This deletes ALL imported data.")) return;
  allTransactions = [];
  importMeta = [];
  localStorage.clear();
  els.status.textContent = "Deleted everything. Import a new CSV to start.";
  els.debug.textContent = "";
  els.monthSelect.value = yyyymmFromDate(new Date());
  els.rangeStart.value = "";
  els.rangeEnd.value = "";
  els.viewMode.value = "range";
  updateDashboard();
});

/* =========================
   Init
========================= */
(function init() {
  els.monthSelect.value = yyyymmFromDate(new Date());

  const { minISO, maxISO } = getDataRange();
  els.rangeStart.value = minISO || "";
  els.rangeEnd.value = maxISO || "";

  // Default to range if there is data
  els.viewMode.value = (minISO && maxISO) ? "range" : "range";
  updateDashboard();
})();
</script>
</body>
</html>
