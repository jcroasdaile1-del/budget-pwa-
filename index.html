<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>Budget Command Center</title>

  <style>
    body { margin:0; font-family:-apple-system,BlinkMacSystemFont,system-ui,sans-serif; background:#0b1220; color:#e8eefc; padding:16px; }
    h1 { font-size:18px; margin:0 0 12px; }
    .card { background:#121a2b; padding:16px; border-radius:12px; margin-bottom:16px; border:1px solid #24314f; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    button { padding:10px 14px; border-radius:10px; border:none; font-weight:700; cursor:pointer; }
    .primary { background:#64d2ff; color:#0b1220; }
    .danger { background:#ff6b6b; color:#fff; }
    input, select { padding:10px; border-radius:10px; border:1px solid #24314f; background:#0f1726; color:#e8eefc; width:100%; margin-bottom:10px; }
    label { font-size:12px; color:#9fb0d0; display:block; margin-bottom:6px; }
    table { width:100%; font-size:12px; border-collapse:collapse; }
    th, td { padding:8px 6px; border-bottom:1px solid #24314f; vertical-align:top; }
    th { color:#9fb0d0; text-align:left; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #24314f; border-radius:999px; color:#9fb0d0; font-size:11px; }
    .pos { color:#6bff95; }
    .neg { color:#ff6b6b; }
    .small { font-size:12px; color:#9fb0d0; line-height:1.4; margin:8px 0 0; }
    .kpi { font-size:34px; font-weight:900; margin:6px 0 0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .btnRow { display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-start; }
  </style>
</head>

<body>
  <h1>Budget Command Center</h1>

  <div class="card">
    <div class="row">
      <div style="min-width:260px;">
        <div class="pill">Remaining This Month</div>
        <div id="remaining" class="kpi">$0.00</div>
        <div id="subline" class="small"></div>
        <div id="balanceLine" class="small"></div>
      </div>

      <div style="min-width:200px;">
        <label for="monthSelect">Month view</label>
        <input id="monthSelect" type="month" />
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px;">Settings (Monthly)</h3>

    <label>Monthly Take-Home Income</label>
    <input id="income" type="number" step="0.01" placeholder="e.g. 9000" />

    <label>Fixed Monthly Costs</label>
    <input id="fixed" type="number" step="0.01" placeholder="e.g. 4500" />

    <label>Goal Funding This Month</label>
    <input id="goals" type="number" step="0.01" placeholder="e.g. 500" />

    <label>Starting Balance (for selected month)</label>
    <input id="startingBalance" type="number" step="0.01" placeholder="e.g. 5000" />

    <label>Exclude Transfers From Spending?</label>
    <select id="excludeTransfers">
      <option value="yes" selected>Yes (recommended)</option>
      <option value="no">No</option>
    </select>

    <div class="btnRow">
      <button class="primary" id="saveSettingsBtn">Save Settings</button>
      <span id="settingsStatus" class="small"></span>
    </div>

    <p class="small">
      Note: “Starting Balance” is used to compute an ending balance for the selected month from imported transactions.
      For account balance math, transfers are included (they affect balance). For spending, transfers are excluded (recommended).
    </p>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px;">Import CSV</h3>
    <input type="file" id="fileInput" accept=".csv,text/csv" />
    <div class="btnRow">
      <button class="primary" id="importBtn">Import</button>
      <button class="danger" id="clearBtn">Clear All Data</button>
    </div>
    <p id="status" class="small"></p>
    <div id="debug" class="small mono"></div>
  </div>

  <div class="card">
    <div class="row">
      <h3 style="margin:0;">Transactions (Selected Month)</h3>
      <span id="countPill" class="pill">0 tx</span>
    </div>

    <div style="overflow:auto; margin-top:10px;">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Merchant</th>
            <th>Type</th>
            <th>Category</th>
            <th class="mono">Amount</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

<script>
/** =========================
 * Robust CSV parser (handles quoted commas)
 * ========================= */
function parseCSV(text) {
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    const next = text[i + 1];

    if (c === '"') {
      if (inQuotes && next === '"') { cur += '"'; i++; }
      else { inQuotes = !inQuotes; }
    } else if (c === ',' && !inQuotes) {
      row.push(cur);
      cur = "";
    } else if ((c === '\n' || c === '\r') && !inQuotes) {
      if (c === '\r' && next === '\n') i++;
      row.push(cur);
      cur = "";
      if (row.some(cell => cell.trim() !== "")) rows.push(row);
      row = [];
    } else {
      cur += c;
    }
  }
  if (cur.length || row.length) {
    row.push(cur);
    rows.push(row);
  }
  return rows;
}

/** =========================
 * Date parsing (MM/DD/YYYY) - Safari-safe
 * ========================= */
function parseUSDate(mmddyyyy) {
  const s = (mmddyyyy || "").trim();
  const parts = s.split("/");
  if (parts.length !== 3) return null;
  const mm = parseInt(parts[0], 10);
  const dd = parseInt(parts[1], 10);
  const yyyy = parseInt(parts[2], 10);
  if (!mm || !dd || !yyyy) return null;
  const d = new Date(yyyy, mm - 1, dd);
  if (Number.isNaN(d.getTime())) return null;
  return d;
}
function yyyymmFromDate(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  return `${y}-${m}`;
}
function money(n) {
  return Number(n || 0).toLocaleString("en-US", { style: "currency", currency: "USD" });
}

/** Money parsing for $ and commas and (neg) */
function parseMoney(value) {
  if (value === null || value === undefined) return null;
  let s = String(value).trim();
  if (!s) return null;

  const isParenNeg = s.startsWith("(") && s.endsWith(")");
  if (isParenNeg) s = s.slice(1, -1);

  s = s.replace(/\$/g, "").replace(/,/g, "").trim();
  const n = Number(s);
  if (Number.isNaN(n)) return null;
  return isParenNeg ? -n : n;
}

/** =========================
 * Storage
 * ========================= */
let allTransactions = JSON.parse(localStorage.getItem("transactions") || "[]");

/** Settings are stored as:
 *  settings.base: general monthly settings
 *  settings.startingBalances: { "YYYY-MM": number }
 */
function loadSettingsRaw() {
  return JSON.parse(localStorage.getItem("settings") || "{}");
}
function saveSettingsRaw(obj) {
  localStorage.setItem("settings", JSON.stringify(obj));
}

/** =========================
 * Normalization / categorization (starter)
 * ========================= */
function normalizeMerchant(raw) {
  let s = (raw || "").toUpperCase().replace(/\s+/g, " ").trim();
  if (s.includes("AMAZON")) return "Amazon";
  if (s.includes("PICK N SAVE")) return "Pick 'n Save";
  if (s.includes("KWIK TRIP")) return "Kwik Trip";
  if (s.includes("EXXON")) return "Exxon";
  if (s.includes("SPECTRUM")) return "Spectrum";
  if (s.includes("USCELL")) return "US Cellular";
  if (s.includes("FID BKG SVC")) return "Fidelity";
  if (s.includes("PAYMENT TO CREDIT CARD") || s.includes("CREDIT CARD")) return "Credit Card Payment";
  return raw || "(Unknown)";
}

function categorize(type, merchant, amount) {
  const t = (type || "").toUpperCase();
  const m = (merchant || "").toUpperCase();

  if (t === "CREDIT" && (m.includes("DEPOSIT") || m.includes("CHECK DEPOSIT") || m.includes("PAYROLL"))) return "Income";
  if (m.includes("PAYMENT TO CREDIT CARD") || m.includes("CREDIT CARD PAYMENT") || m.includes("CREDIT CARD")) return "Transfer";
  if (m.includes("FIDELITY") || m.includes("FID BKG")) return "Investing";
  if (m.includes("SPECTRUM")) return "Utilities";
  if (m.includes("US CELL") || m.includes("USCELL")) return "Phone";
  if (m.includes("KWIK TRIP") || m.includes("EXXON")) return "Gas";
  if (m.includes("AMAZON")) return "Shopping";
  if (m.includes("PICK N SAVE")) return "Groceries";

  return amount < 0 ? "Discretionary" : "Other";
}

/** =========================
 * Flexible header mapping
 * ========================= */
function indexOfAny(headers, candidates) {
  const upper = headers.map(h => (h || "").trim().toUpperCase());
  for (const c of candidates) {
    const idx = upper.indexOf(c.toUpperCase());
    if (idx >= 0) return idx;
  }
  return -1;
}

/** =========================
 * UI Elements
 * ========================= */
const els = {
  monthSelect: document.getElementById("monthSelect"),
  remaining: document.getElementById("remaining"),
  subline: document.getElementById("subline"),
  balanceLine: document.getElementById("balanceLine"),
  income: document.getElementById("income"),
  fixed: document.getElementById("fixed"),
  goals: document.getElementById("goals"),
  startingBalance: document.getElementById("startingBalance"),
  excludeTransfers: document.getElementById("excludeTransfers"),
  saveSettingsBtn: document.getElementById("saveSettingsBtn"),
  settingsStatus: document.getElementById("settingsStatus"),
  fileInput: document.getElementById("fileInput"),
  importBtn: document.getElementById("importBtn"),
  clearBtn: document.getElementById("clearBtn"),
  status: document.getElementById("status"),
  debug: document.getElementById("debug"),
  countPill: document.getElementById("countPill"),
  tableBody: document.getElementById("tableBody")
};

/** =========================
 * Settings
 * ========================= */
function loadSettingsForUI() {
  const raw = loadSettingsRaw();
  const base = raw.base || {};
  const startingBalances = raw.startingBalances || {};

  els.income.value = base.income ?? "";
  els.fixed.value = base.fixed ?? "";
  els.goals.value = base.goals ?? "";
  els.excludeTransfers.value = (base.excludeTransfers ?? true) ? "yes" : "no";

  const selMonth = els.monthSelect.value || yyyymmFromDate(new Date());
  els.startingBalance.value = (startingBalances[selMonth] ?? "");

  return {
    income: Number(base.income || 0),
    fixed: Number(base.fixed || 0),
    goals: Number(base.goals || 0),
    excludeTransfers: (base.excludeTransfers ?? true),
    startingBalances
  };
}

function saveSettingsFromUI() {
  const raw = loadSettingsRaw();
  const base = raw.base || {};
  const startingBalances = raw.startingBalances || {};

  base.income = Number(els.income.value || 0);
  base.fixed = Number(els.fixed.value || 0);
  base.goals = Number(els.goals.value || 0);
  base.excludeTransfers = (els.excludeTransfers.value === "yes");

  const selMonth = els.monthSelect.value || yyyymmFromDate(new Date());
  const sb = parseMoney(els.startingBalance.value);
  if (sb === null) {
    delete startingBalances[selMonth];
  } else {
    startingBalances[selMonth] = sb;
  }

  saveSettingsRaw({ base, startingBalances });

  els.settingsStatus.textContent = "Saved.";
  setTimeout(() => els.settingsStatus.textContent = "", 1200);
  updateDashboard();
}

/** =========================
 * Import
 * - Imports ALL rows, dedupes on date+merchant+amount
 * - If CSV has Balance/Running Balance column, we store it (optional)
 * ========================= */
async function importCSVFile(file) {
  const text = await file.text();
  const rows = parseCSV(text);

  if (rows.length < 2) throw new Error("CSV looks empty.");

  const header = rows[0].map(h => (h || "").trim());
  const iDate = indexOfAny(header, ["Date", "Posting Date", "Transaction Date"]);
  const iType = indexOfAny(header, ["Transaction", "Type"]);
  const iMerchant = indexOfAny(header, ["Merchant", "Name", "Description"]);
  const iMemo = indexOfAny(header, ["Memo", "Details", "Note"]);
  const iAmount = indexOfAny(header, ["Amount", "Transaction Amount"]);
  const iBalance = indexOfAny(header, ["Balance", "Running Balance"]);

  if (iDate < 0 || iMerchant < 0 || iAmount < 0) {
    throw new Error("Missing required columns. Need at least: Date + Merchant/Description + Amount.");
  }

  let added = 0, skipped = 0, failed = 0;
  const debugRows = [];

  for (const r of rows.slice(1)) {
    try {
      const dateStr = (r[iDate] ?? "").trim();
      const type = (iType >= 0 ? (r[iType] ?? "").trim() : "").toUpperCase();
      const rawMerchant = (r[iMerchant] ?? "").trim();
      const memo = iMemo >= 0 ? (r[iMemo] ?? "").trim() : "";
      const amount = parseMoney(r[iAmount]);

      const d = parseUSDate(dateStr);
      if (!d || amount === null) { failed++; continue; }

      const normalized = normalizeMerchant(rawMerchant);
      const category = categorize(type, normalized, amount);
      const month = yyyymmFromDate(d);
      const dateISO = d.toISOString().slice(0, 10);

      const balance = (iBalance >= 0) ? parseMoney(r[iBalance]) : null;

      const key = `${dateISO}|${normalized}|${amount.toFixed(2)}`;
      const exists = allTransactions.some(t => t.key === key);
      if (exists) { skipped++; continue; }

      const record = {
        key,
        dateISO,
        month,
        type,
        rawMerchant,
        merchant: normalized,
        memo,
        amount,
        balance,
        category
      };

      allTransactions.push(record);
      added++;

      if (debugRows.length < 3) debugRows.push(record);
    } catch {
      failed++;
    }
  }

  localStorage.setItem("transactions", JSON.stringify(allTransactions));
  return { added, skipped, failed, debugRows, hasBalance: (iBalance >= 0) };
}

/** =========================
 * Dashboard
 * ========================= */
function updateDashboard() {
  const settings = loadSettingsForUI();
  const raw = loadSettingsRaw();
  const base = raw.base || {};
  const startingBalances = raw.startingBalances || {};

  const selectedMonth = els.monthSelect.value || yyyymmFromDate(new Date());
  const monthTx = allTransactions.filter(t => t.month === selectedMonth);

  // Spending (transfers optionally excluded)
  const spending = monthTx
    .filter(t => t.amount < 0)
    .filter(t => (base.excludeTransfers ?? true) ? t.category !== "Transfer" : true)
    .reduce((sum, t) => sum + Math.abs(t.amount), 0);

  const income = Number(base.income || 0);
  const fixed = Number(base.fixed || 0);
  const goals = Number(base.goals || 0);
  const remaining = income - fixed - goals - spending;

  els.remaining.textContent = money(remaining);
  els.remaining.style.color = remaining >= 0 ? "#6bff95" : "#ff6b6b";

  els.subline.textContent =
    `Month: ${selectedMonth} • Spending: ${money(spending)} • Transfers excluded: ${(base.excludeTransfers ?? true) ? "Yes" : "No"}`;

  // BALANCE: computed from starting balance + net change (including transfers)
  const startBal = (typeof startingBalances[selectedMonth] === "number") ? startingBalances[selectedMonth] : null;
  if (startBal === null) {
    els.balanceLine.textContent = "Balance: set a Starting Balance for this month to compute End Balance.";
  } else {
    // Net change includes all tx (including transfers) because they affect account balance.
    const netChangeAll = monthTx.reduce((sum, t) => sum + Number(t.amount || 0), 0);
    const endBal = startBal + netChangeAll;
    els.balanceLine.textContent = `Start bal: ${money(startBal)} • Net change: ${money(netChangeAll)} • End bal: ${money(endBal)}`;
  }

  els.countPill.textContent = `${monthTx.length} tx`;

  // Table
  els.tableBody.innerHTML = "";
  monthTx
    .slice()
    .sort((a,b) => a.dateISO < b.dateISO ? 1 : -1)
    .slice(0, 300)
    .forEach(t => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="mono">${t.dateISO}</td>
        <td>${t.merchant}</td>
        <td class="mono">${t.type || ""}</td>
        <td><span class="pill">${t.category}</span></td>
        <td class="mono ${t.amount >= 0 ? 'pos' : 'neg'}">${money(t.amount)}</td>
      `;
      els.tableBody.appendChild(row);
    });
}

/** =========================
 * Clear
 * ========================= */
function clearAll() {
  if (!confirm("Delete all transactions + settings on this device?")) return;
  allTransactions = [];
  localStorage.clear();
  els.status.textContent = "Cleared.";
  els.debug.textContent = "";
  els.monthSelect.value = yyyymmFromDate(new Date());
  updateDashboard();
}

/** =========================
 * Wire UI
 * ========================= */
els.saveSettingsBtn.addEventListener("click", saveSettingsFromUI);

els.monthSelect.addEventListener("change", () => {
  // When month changes, update the starting balance input to match that month
  loadSettingsForUI();
  updateDashboard();
});

els.clearBtn.addEventListener("click", clearAll);

els.importBtn.addEventListener("click", async () => {
  const f = els.fileInput.files && els.fileInput.files[0];
  if (!f) { els.status.textContent = "Pick a CSV file first."; return; }

  els.status.textContent = "Importing…";
  els.debug.textContent = "";

  try {
    const res = await importCSVFile(f);

    els.status.textContent =
      `Imported. Added ${res.added}, skipped ${res.skipped} dupes, failed ${res.failed}. Balance column in CSV: ${res.hasBalance ? "Yes" : "No"}`;

    if (res.debugRows.length) {
      els.debug.textContent =
        "Parsed sample rows:\n" + res.debugRows.map(r =>
          `${r.dateISO} | ${r.merchant} | ${r.amount} | ${r.category}`
        ).join("\n");
    } else {
      els.debug.textContent = "No rows parsed. If this happens, paste your CSV header row here and I’ll map it.";
    }

    updateDashboard();
  } catch (e) {
    els.status.textContent = `Import failed: ${e.message || e}`;
  } finally {
    els.fileInput.value = "";
  }
});

/** =========================
 * Init
 * ========================= */
(function init() {
  els.monthSelect.value = yyyymmFromDate(new Date());
  loadSettingsForUI();
  updateDashboard();
})();
</script>

</body>
</html>
